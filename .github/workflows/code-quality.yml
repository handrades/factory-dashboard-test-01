name: 📊 Code Quality Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # TypeScript Code Quality
  typescript-quality:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📥 Install dependencies
        run: npm ci

      - name: 🔍 TypeScript strict check
        run: |
          # Check with strictest settings
          echo "Checking TypeScript with strict settings..."
          npx tsc --project config/tsconfig.json --noEmit

      - name: 📊 Code complexity analysis
        run: |
          # Install complexity analysis tools
          npm install -g ts-complex || echo "ts-complex installation failed, skipping complexity analysis"
          if command -v ts-complex &> /dev/null; then
            echo "Analyzing TypeScript code complexity..."
            npx ts-complex src/ --threshold 10 || true
          else
            echo "ts-complex not available, skipping complexity analysis"
          fi

  # Build Shared Types for Testing
  shared-types-for-tests:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/shared-types/package-lock.json

      - name: 📥 Install shared-types dependencies
        working-directory: services/shared-types
        run: npm ci

      - name: 🏗️ Build shared-types
        working-directory: services/shared-types
        run: npm run build

      - name: 📦 Upload shared-types build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: shared-types-test-dist
          path: services/shared-types/dist/

  # Code Coverage and Testing
  test-coverage:
    runs-on: ubuntu-latest
    needs: shared-types-for-tests
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📥 Download shared-types build artifacts
        uses: actions/download-artifact@v3
        with:
          name: shared-types-test-dist
          path: services/shared-types/dist/

      - name: 📥 Install dependencies
        run: npm ci

      - name: 🧪 Run tests with coverage (Frontend)
        run: |
          # Add test coverage for frontend if tests exist
          if [ -f "jest.config.js" ] || grep -q '"test"' package.json; then
            npm test -- --coverage --watchAll=false
          else
            echo "No frontend tests configured"
          fi

      - name: 🧪 Run backend service tests
        run: |
          # Install shared-types dependencies first
          cd services/shared-types && npm ci && cd ../..
          
          for service in services/*/; do
            service_name=$(basename "$service")
            if [ -f "$service/package.json" ] && [ "$service_name" != "shared-types" ]; then
              echo "Testing $service"
              cd "$service"
              if [ -f "jest.config.js" ] || grep -q '"test"' package.json; then
                npm ci
                npm test
              else
                echo "No tests found for $service"
              fi
              cd - > /dev/null
            fi
          done

  # Dependency Analysis
  dependency-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📥 Install dependencies
        run: npm ci

      - name: 🔍 Dependency vulnerabilities
        run: |
          # Check for vulnerabilities
          npm audit --audit-level=low --json > audit-results.json || true
          
          # Install dependency analysis tools
          npm install -g npm-check-updates depcheck

      - name: 📊 Outdated dependencies
        run: |
          echo "Checking for outdated dependencies..."
          ncu --format group
          
          # Check for unused dependencies
          echo "Checking for unused dependencies..."
          npx depcheck --json > depcheck-results.json || true

      - name: 📊 Bundle size analysis
        run: |
          # Build and analyze bundle size
          npm run build
          
          # Install bundle analyzer
          npm install -g webpack-bundle-analyzer
          
          # Generate bundle stats (if webpack is used)
          if [ -f "webpack.config.js" ] || [ -f "vite.config.ts" ]; then
            echo "Bundle analysis would go here"
            # This would need to be configured based on your build tool
          fi

  # Code Quality Metrics
  sonarcloud-analysis:
    runs-on: ubuntu-latest
    if: false  # Temporarily disabled until SONAR_TOKEN is configured
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          # Full history for better analysis
          fetch-depth: 0

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📥 Install dependencies
        run: npm ci

      - name: 🧪 Generate test coverage
        run: |
          # Generate coverage reports for SonarCloud
          if [ -f "jest.config.js" ] || grep -q '"test"' package.json; then
            npm test -- --coverage --watchAll=false --coverageReporters=lcov || true
          fi

      - name: 📊 SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=handrades_factory-dashboard-test-01
            -Dsonar.organization=handrades
            -Dsonar.sources=src/,services/
            -Dsonar.tests=src/,services/,tests/
            -Dsonar.test.inclusions=**/*.test.ts,**/*.test.tsx,**/*.spec.ts
            -Dsonar.typescript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.testExecutionReportPaths=coverage/test-reporter.xml
            -Dsonar.coverage.exclusions=**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/node_modules/**

  # Performance Analysis
  performance-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📥 Install dependencies
        run: npm ci

      - name: 🏗️ Build for production
        run: npm run build

      - name: 📊 Bundle analysis
        run: |
          # Install bundle analysis tools
          npm install -g bundlesize
          
          # Analyze bundle sizes
          echo "Analyzing bundle sizes..."
          ls -la dist/ || ls -la build/ || echo "No build directory found"

      - name: 🚀 Lighthouse CI
        run: |
          # Install Lighthouse CI and serve
          npm install -g @lhci/cli serve || echo "Lighthouse CI installation failed"
          
          if command -v lhci &> /dev/null && [ -f ".github/lighthouse-ci.json" ] && [ -d "dist" ]; then
            # Start a simple HTTP server for the built assets
            npx serve -s dist -l 3000 &
            SERVER_PID=$!
            
            # Wait for server to start
            sleep 10
            
            # Run Lighthouse CI on the served application
            lhci autorun --config=.github/lighthouse-ci.json || true
            
            # Clean up
            kill $SERVER_PID || true
          else
            echo "Lighthouse CI skipped - missing requirements (lhci, config file, or dist directory)"
          fi

  # Documentation Quality
  docs-quality:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 📦 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 📥 Install documentation tools
        run: |
          pip install mkdocs mkdocs-material
          npm install -g documentation

      - name: 📊 Generate API documentation
        run: |
          # Install TypeDoc
          npm install -g typedoc || echo "TypeDoc installation failed"
          
          # Generate TypeScript API docs
          if command -v typedoc &> /dev/null; then
            npx typedoc src/ --out docs/api --theme minimal || echo "TypeDoc generation skipped - no entry points found"
          else
            echo "TypeDoc not available, skipping API documentation generation"
          fi

      - name: 🔍 Documentation coverage
        run: |
          # Check for missing documentation
          echo "Checking documentation coverage..."
          find src/ -name "*.ts" -not -name "*.test.ts" -not -name "*.spec.ts" | while read file; do
            if ! grep -q "@param\|@returns\|@description\|/\*\*" "$file"; then
              echo "Missing documentation: $file"
            fi
          done

  # Code Quality Summary
  quality-summary:
    runs-on: ubuntu-latest
    needs: [typescript-quality, shared-types-for-tests, test-coverage, dependency-analysis, performance-analysis, docs-quality]
    if: always()
    steps:
      - name: 📊 Generate quality report
        run: |
          echo "## 📊 Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.typescript-quality.result }}" == "success" ]]; then
            echo "✅ TypeScript Quality: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ TypeScript Quality: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.test-coverage.result }}" == "success" ]]; then
            echo "✅ Test Coverage: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Test Coverage: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.dependency-analysis.result }}" == "success" ]]; then
            echo "✅ Dependency Analysis: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Dependency Analysis: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.performance-analysis.result }}" == "success" ]]; then
            echo "✅ Performance Analysis: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Performance Analysis: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.docs-quality.result }}" == "success" ]]; then
            echo "✅ Documentation Quality: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Documentation Quality: Failed" >> $GITHUB_STEP_SUMMARY
          fi